<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Degen Spin</title>
  <meta name="description" content="Onchain-style slot mini game for Farcaster: spin, win, stack virtual coins." />

  <!-- Farcaster Mini App / Frame meta (replace your-domain.com with your domain) -->
  <meta
    name="fc:miniapp"
    content='{
      "version":"next",
      "imageUrl":"https://your-domain.com/og-hero.png",
      "button":{
        "title":"Play Degen Spin",
        "action":{
          "type":"launch_miniapp",
          "name":"Degen Spin",
          "url":"https://your-domain.com"
        }
      }
    }'
  />
  <meta
    name="fc:frame"
    content='{
      "version":"next",
      "imageUrl":"https://your-domain.com/og-hero.png",
      "button":{
        "title":"Play Degen Spin",
        "action":{
          "type":"launch_miniapp",
          "name":"Degen Spin",
          "url":"https://your-domain.com"
        }
      }
    }'
  />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color-scheme: dark;
      --bg: #050509;
      --card: #11111a;
      --card-soft: #151525;
      --accent: #9d6bff;
      --accent-soft: rgba(157, 107, 255, 0.2);
      --accent-strong: #c49dff;
      --win: #3dd68c;
      --lose: #ff4d6a;
      --text: #f5f5ff;
      --muted: #a0a0b8;
      --border: #25253a;
      --radius-lg: 22px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1c1236 0, #050509 55%);
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text);
    }

    .app-root {
      width: 100%;
      max-width: 424px;
      margin: 0 auto;
      padding: 16px 12px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      background: linear-gradient(145deg, #151525, #090913);
      border-radius: 24px;
      padding: 18px 16px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-dot {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 15% 15%, #fff 0, #ffdd99 18%, #ff6fb7 40%, #38106f 75%, #050509 100%);
      border: 1px solid #ffffff33;
      box-shadow: 0 0 18px rgba(255, 165, 255, 0.4);
      flex-shrink: 0;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(7, 7, 15, 0.9);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    h1 {
      margin: 0;
      font-size: 18px;
      line-height: 1.2;
    }

    .balance-block {
      text-align: right;
      font-size: 12px;
    }

    .balance-label {
      color: var(--muted);
      margin-bottom: 2px;
    }

    .balance-value {
      font-weight: 700;
      font-size: 16px;
    }

    .balance-value span {
      color: var(--accent-strong);
    }

    .mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      margin-top: 4px;
    }

    .mode-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #2a2a3d;
      padding: 5px 0;
      font-size: 12px;
      cursor: pointer;
      background: rgba(6, 6, 14, 0.95);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease,
        transform 0.06s ease;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #ffce6f, #ff6fb7);
      color: #16121f;
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(255, 120, 180, 0.55);
    }

    .mode-btn span {
      font-size: 13px;
      font-weight: 600;
    }

    .machine {
      margin-top: 4px;
      padding: 12px 10px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, #22153f 0, #0b0b16 55%);
      border: 1px solid #31264d;
    }

    .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .cost-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #3b3058;
      background: rgba(5, 5, 9, 0.9);
      font-size: 11px;
    }

    .slots-row {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .slot {
      flex: 1;
      aspect-ratio: 1 / 1;
      max-height: 78px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #2f224d 0, #120f1f 55%);
      border: 1px solid #3b3058;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      user-select: none;
    }

    .slot.spin {
      animation: spin 0.4s ease-out;
    }

    @keyframes spin {
      0% {
        transform: translateY(-6px) scale(1.04);
        opacity: 0.6;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .controls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .btn {
      flex: 1;
      padding: 11px 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease,
        opacity 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffce6f, #ff6fb7);
      color: #16121f;
      box-shadow: 0 10px 22px rgba(255, 120, 180, 0.7);
    }

    .btn-secondary {
      background: rgba(6, 6, 14, 0.95);
      color: var(--muted);
      border: 1px solid #2a2a3d;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      min-height: 18px;
    }

    .status span {
      font-weight: 600;
    }

    .status.win span {
      color: var(--win);
    }

    .status.lose span {
      color: var(--lose);
    }

    .stats {
      margin-top: 8px;
      padding: 8px 9px 6px;
      border-radius: 16px;
      background: rgba(7, 7, 15, 0.9);
      border: 1px dashed #26263a;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }

    .stats div {
      min-width: 45%;
    }

    .stats strong {
      color: var(--accent-strong);
    }

    .footer {
      margin-top: 10px;
      font-size: 10px;
      text-align: center;
      color: #707090;
    }

    @media (max-height: 620px) {
      .app-root { align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="app-root">
    <main class="card" id="game">
      <header class="top-row">
        <div class="title-block">
          <div class="logo-dot"></div>
          <div>
            <div class="pill">Farcaster Mini Game</div>
            <h1>Degen Spin</h1>
          </div>
        </div>
        <div class="balance-block">
          <div class="balance-label">Balance</div>
          <div class="balance-value"><span id="balanceValue">100</span> ‚ú®</div>
        </div>
      </header>

      <div class="mode-toggle">
        <button class="mode-btn active" id="modeSafeBtn" type="button">
          üßä <span>Safe</span>
        </button>
        <button class="mode-btn" id="modeDegenBtn" type="button">
          üî• <span>Degen</span>
        </button>
      </div>

      <section class="machine">
        <div class="machine-header">
          <div id="modeLabel">Low risk, chill spins.</div>
          <div class="cost-pill">
            Spin cost: <strong id="spinCostText">5</strong> ‚ú®
          </div>
        </div>

        <div class="slots-row">
          <div class="slot" id="slot1">üçá</div>
          <div class="slot" id="slot2">üçã</div>
          <div class="slot" id="slot3">üçí</div>
        </div>

        <div class="controls">
          <button class="btn btn-secondary" id="resetBtn" type="button">
            Reset
          </button>
          <button class="btn btn-primary" id="spinBtn" type="button">
            Spin
          </button>
        </div>

        <div class="status" id="statusText">
          Tap <span>Spin</span> to play.
        </div>

        <div class="stats">
          <div>Spins: <strong id="statsSpins">0</strong></div>
          <div>Wins: <strong id="statsWins">0</strong></div>
          <div>Best win: <strong id="statsBestWin">0</strong> ‚ú®</div>
          <div>Streak: <strong id="statsStreak">0</strong> üî•</div>
          <div>Daily bonus: <strong id="statsBonus">0</strong> ‚ú®</div>
        </div>
      </section>

      <footer class="footer">
        Virtual-only game ¬∑ No real money ¬∑ Share your best hit in a cast üü£
      </footer>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "degenSpin_v2";

      const START_BALANCE = 100;
      const DAILY_BONUS = 15;

      const SYMBOLS = ["üçá", "üçã", "üçí", "‚≠ê", "üíé"];

      const MODES = {
        safe: { key: "safe", label: "Low risk, chill spins.", cost: 5 },
        degen: { key: "degen", label: "Higher risk, bigger hits.", cost: 10 }
      };

      let modeKey = "safe";
      let balance = START_BALANCE;
      let spins = 0;
      let wins = 0;
      let bestWin = 0;
      let streakDays = 0;
      let lastPlayDate = null;
      let lastBonusDate = null;
      let dailyBonusToday = 0;
      let isSpinning = false;

      const balanceValueEl = document.getElementById("balanceValue");
      const spinCostTextEl = document.getElementById("spinCostText");
      const modeLabelEl = document.getElementById("modeLabel");
      const slotEls = [
        document.getElementById("slot1"),
        document.getElementById("slot2"),
        document.getElementById("slot3"),
      ];
      const spinBtn = document.getElementById("spinBtn");
      const resetBtn = document.getElementById("resetBtn");
      const statusTextEl = document.getElementById("statusText");
      const statsSpinsEl = document.getElementById("statsSpins");
      const statsWinsEl = document.getElementById("statsWins");
      const statsBestWinEl = document.getElementById("statsBestWin");
      const statsStreakEl = document.getElementById("statsStreak");
      const statsBonusEl = document.getElementById("statsBonus");
      const modeSafeBtn = document.getElementById("modeSafeBtn");
      const modeDegenBtn = document.getElementById("modeDegenBtn");

      function getTodayStr() {
        const d = new Date();
        const y = d.getFullYear();
        const m = (d.getMonth() + 1).toString().padStart(2, "0");
        const day = d.getDate().toString().padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function parseDate(str) {
        if (!str) return null;
        const [y, m, d] = str.split("-").map((v) => parseInt(v, 10));
        return new Date(y, m - 1, d);
      }

      function daysBetween(d1Str, d2Str) {
        const d1 = parseDate(d1Str);
        const d2 = parseDate(d2Str);
        if (!d1 || !d2) return NaN;
        const ms = d2.getTime() - d1.getTime();
        return Math.round(ms / (1000 * 60 * 60 * 24));
      }

      function randomSymbol() {
        const idx = Math.floor(Math.random() * SYMBOLS.length);
        return SYMBOLS[idx];
      }

      function calcPayout(symbols, mode) {
        const [a, b, c] = symbols;
        const allSame = a === b && b === c;
        const anyPair = a === b || a === c || b === c;
        const hasDiamond = symbols.includes("üíé");
        const hasStar = symbols.includes("‚≠ê");

        if (mode === "safe") {
          if (allSame) {
            if (a === "üíé") return 40;
            if (a === "‚≠ê") return 25;
            return 15;
          }
          if (anyPair) return 5;
          return 0;
        } else {
          if (Math.random() < 0.02) return 200;
          if (allSame) {
            if (a === "üíé") return 100;
            if (a === "‚≠ê") return 50;
            return 20;
          }
          if (anyPair) return 8;
          if (hasDiamond || hasStar) return 3;
          return 0;
        }
      }

      function setStatus(text, type) {
        statusTextEl.textContent = "";
        const span = document.createElement("span");
        span.textContent = text;
        statusTextEl.classList.remove("win", "lose");
        if (type === "win") statusTextEl.classList.add("win");
        if (type === "lose") statusTextEl.classList.add("lose");
        statusTextEl.appendChild(span);
      }

      function updateModeUI() {
        const cfg = MODES[modeKey];
        modeLabelEl.textContent = cfg.label;
        spinCostTextEl.textContent = cfg.cost;
        if (modeKey === "safe") {
          modeSafeBtn.classList.add("active");
          modeDegenBtn.classList.remove("active");
        } else {
          modeSafeBtn.classList.remove("active");
          modeDegenBtn.classList.add("active");
        }
      }

      function updateUI() {
        balanceValueEl.textContent = balance;
        statsSpinsEl.textContent = spins;
        statsWinsEl.textContent = wins;
        statsBestWinEl.textContent = bestWin;
        statsStreakEl.textContent = streakDays || 0;
        statsBonusEl.textContent = dailyBonusToday || 0;
        updateModeUI();
        const cost = MODES[modeKey].cost;
        if (balance < cost || isSpinning) {
          spinBtn.disabled = true;
        } else {
          spinBtn.disabled = false;
        }
      }

      function saveState() {
        const state = {
          modeKey,
          balance,
          spins,
          wins,
          bestWin,
          streakDays,
          lastPlayDate,
          lastBonusDate,
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {}
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const s = JSON.parse(raw);
          if (s.modeKey && MODES[s.modeKey]) modeKey = s.modeKey;
          if (typeof s.balance === "number") balance = s.balance;
          if (typeof s.spins === "number") spins = s.spins;
          if (typeof s.wins === "number") wins = s.wins;
          if (typeof s.bestWin === "number") bestWin = s.bestWin;
          if (typeof s.streakDays === "number") streakDays = s.streakDays;
          if (s.lastPlayDate) lastPlayDate = s.lastPlayDate;
          if (s.lastBonusDate) lastBonusDate = s.lastBonusDate;
        } catch (e) {
          console.debug("Failed to load state", e);
        }
      }

      function applyDailyBonusOnLoad() {
        const today = getTodayStr();
        if (lastBonusDate === today) {
          dailyBonusToday = DAILY_BONUS;
          return;
        }
        balance += DAILY_BONUS;
        dailyBonusToday = DAILY_BONUS;
        lastBonusDate = today;
        setStatus(`Daily bonus +${DAILY_BONUS} ‚ú®`, "win");
      }

      function updateStreakAfterPlay() {
        const today = getTodayStr();
        if (lastPlayDate === today) return;
        if (!lastPlayDate) {
          streakDays = 1;
        } else {
          const diff = daysBetween(lastPlayDate, today);
          if (diff === 1) {
            streakDays = (streakDays || 0) + 1;
          } else {
            streakDays = 1;
          }
        }
        lastPlayDate = today;
      }

      function spin() {
        if (isSpinning) return;
        const cfg = MODES[modeKey];
        const cost = cfg.cost;
        if (balance < cost) {
          setStatus("No coins left. Tap Reset.", "lose");
          updateUI();
          return;
        }
        isSpinning = true;
        spinBtn.disabled = true;

        balance -= cost;
        spins += 1;
        updateUI();

        const symbols = [];
        slotEls.forEach((slot, index) => {
          slot.classList.remove("spin");
          void slot.offsetWidth;
          slot.classList.add("spin");
          const sym = randomSymbol();
          symbols.push(sym);
          setTimeout(() => {
            slot.textContent = sym;
          }, 80 + index * 80);
        });

        setTimeout(() => {
          const payout = calcPayout(symbols, modeKey);
          if (payout > 0) {
            balance += payout;
            wins += 1;
            if (payout > bestWin) bestWin = payout;
            setStatus(`You won +${payout} ‚ú®`, "win");
            updateStreakAfterPlay();
            if (window.__miniAppSDK && payout >= 25) {
              const profile = modeKey === "degen" ? "Degen mode" : "Safe mode";
              const text = `Hit a +${payout} ‚ú® win in Degen Spin (${profile}), streak ${streakDays} üî•`;
              window.__miniAppSDK.actions
                .composeCast({ text })
                .catch(() => {});
            }
          } else {
            setStatus(`No luck this time.`, "lose");
            updateStreakAfterPlay();
          }
          isSpinning = false;
          saveState();
          updateUI();
          if (balance < MODES[modeKey].cost) {
            setStatus("Balance empty. Tap Reset to start again.", "lose");
          }
        }, 450);
      }

      function resetGame() {
        balance = START_BALANCE;
        spins = 0;
        wins = 0;
        bestWin = 0;
        slotEls[0].textContent = "üçá";
        slotEls[1].textContent = "üçã";
        slotEls[2].textContent = "üçí";
        setStatus("Tap Spin to play.", null);
        isSpinning = false;
        dailyBonusToday = 0;
        saveState();
        updateUI();
      }

      spinBtn.addEventListener("click", spin);
      resetBtn.addEventListener("click", resetGame);

      modeSafeBtn.addEventListener("click", () => {
        if (modeKey === "safe") return;
        modeKey = "safe";
        setStatus("Safe mode: softer payouts, cheaper spins.", null);
        saveState();
        updateUI();
      });

      modeDegenBtn.addEventListener("click", () => {
        if (modeKey === "degen") return;
        modeKey = "degen";
        setStatus("Degen mode: more risk, bigger hits.", null);
        saveState();
        updateUI();
      });

      loadState();
      applyDailyBonusOnLoad();
      updateUI();
      saveState();
    })();
  </script>

  <script type="module">
    (async () => {
      try {
        const { sdk } = await import("https://esm.sh/@farcaster/miniapp-sdk");
        window.__miniAppSDK = sdk;
        await sdk.actions.ready();
      } catch (e) {
        console.debug("Mini app SDK not available:", e?.message);
      }
    })();
  </script>
</body>
</html>
